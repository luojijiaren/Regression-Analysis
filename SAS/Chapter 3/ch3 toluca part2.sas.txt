* Loess fits;
* Figure 3.19(a);
ods listing close;
proc loess data = ma542.toluca;
  model workhours=lotsize / degree=2  smooth = .85;
  ods output OutputStatistics=results;
run;
ods listing;
proc sort data = results;
 by lotsize;
run;
* Figure 3.19(b);
data results1 (rename = ( Depvar=workhours pred=loess) );
  set results;
run;
proc reg data = results1 noprint;
 model workhours=lotsize;
 output out=temp lclm=lower uclm=upper;
run;
quit;
proc sgplot data=temp;
 series x=lotsize y=lower/ lineattrs= (pattern=dash color=red);
 series x=lotsize y=upper/ lineattrs= (pattern=dash color=red);
 series x=lotsize y=loess;
run;
*Let's loess residuals;
proc reg data = ma542.toluca noprint outest=zzzout edf;
  model workhours=lotsize;
  output out=temp5 residual=resid p=fitted;
run;
quit;
ods listing close;
proc loess data = temp5;
  model resid=lotsize / degree=2  smooth = .85;
  ods output OutputStatistics=results5;
run;
ods listing;
data results5;
 set results5;
 resid=DepVar;
 abs_resid=abs(DepVar);
 pred1=pred;
 keep lotsize resid abs_resid pred1;
run;
proc sort data = results5;
 by lotsize;
run;
ods listing close;
proc loess data = results5;
  model abs_resid=lotsize / degree=2  smooth = .85;
  ods output OutputStatistics=results6;
run;
ods listing;
